<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Proteínas e Carboidratos para Recomposição Corporal</title>

    <!-- Ícone -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='25' fill='%2310b981'/%3E%3Cpath d='M50 20 C75 20 85 40 85 60 C85 85 60 85 50 85 C40 85 15 85 15 60 C15 40 25 20 50 20 Z' fill='white'/%3E%3Cpath d='M50 20 L50 85' stroke='%2310b981' stroke-width='4'/%3E%3C/svg%3E"
    />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              display: ["Poppins", "sans-serif"],
            },
            colors: {
              brand: {
                50: "#ecfdf5",
                100: "#d1fae5",
                500: "#10b981",
                600: "#059669",
                900: "#064e3b",
              },
            },
            boxShadow: {
              soft: "0 10px 40px -10px rgba(0,0,0,0.08)",
              "inner-light": "inset 0 2px 4px 0 rgba(255, 255, 255, 0.3)",
            },
          },
        },
      };
    </script>

    <style>
      body {
        background-color: #f8fafc;
        -webkit-tap-highlight-color: transparent;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .checkbox-bounce {
        animation: bounce 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      @keyframes bounce {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      .liquid-bg {
        background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
        transition: height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .progress-ring__circle {
        transition: stroke-dashoffset 0.5s ease-in-out, stroke 0.3s;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
      }
    </style>
  </head>
  <body class="text-slate-800 pb-12">
    <!-- Top Bar -->
    <div
      class="fixed top-0 w-full z-40 bg-white/80 backdrop-blur-md border-b border-slate-100 transition-all duration-300"
      id="navbar"
    >
      <div class="max-w-md mx-auto px-6 py-4 flex justify-between items-center">
        <div>
          <!-- O JavaScript irá substituir este texto automaticamente pela data de hoje -->
          <p
            class="text-xs font-semibold text-slate-400 tracking-wider"
            id="current-date"
          >
            CARREGANDO...
          </p>
          <!-- Adicionado ID para atualização via JS -->
          <h1
            class="text-xl font-display font-bold text-slate-800"
            id="current-weekday"
          >
            Hoje
          </h1>

          <!-- Perfil (Clicável para editar) -->
          <div
            onclick="editWeight()"
            id="profile-summary"
            class="group cursor-pointer flex items-center gap-2 text-xs text-brand-600 font-medium mt-1 opacity-0 transition-opacity duration-500 hover:text-brand-800 bg-brand-50 w-fit px-2 py-1 rounded-lg border border-brand-100 select-none"
          >
            <span id="profile-text" class="transition-all duration-300"
              >--</span
            >
            <i
              class="fas fa-pen text-[10px] opacity-50 group-hover:opacity-100"
            ></i>
          </div>
        </div>

        <!-- Auth Status Indicator -->
        <div
          id="auth-status"
          class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 font-bold shadow-sm transition-colors duration-500 cursor-help"
          title="Status da Conexão"
        >
          <i class="fas fa-sync fa-spin text-xs"></i>
        </div>
      </div>
    </div>

    <main class="max-w-md mx-auto px-5 mt-24 space-y-6">
      <!-- Dashboard Macros -->
      <section class="grid grid-cols-3 gap-3">
        <!-- PROTEÍNA -->
        <div
          class="bg-white p-4 rounded-2xl shadow-soft flex flex-col items-center justify-center relative overflow-hidden group"
        >
          <svg
            class="w-16 h-16 transform transition-transform group-hover:scale-105"
            viewBox="0 0 100 100"
          >
            <circle
              class="text-slate-100"
              stroke-width="8"
              stroke="currentColor"
              fill="transparent"
              r="42"
              cx="50"
              cy="50"
            />
            <circle
              id="ring-p"
              class="text-brand-500 progress-ring__circle"
              stroke-width="8"
              stroke-linecap="round"
              stroke="currentColor"
              fill="transparent"
              r="42"
              cx="50"
              cy="50"
              stroke-dasharray="263.8"
              stroke-dashoffset="0"
            />
            <foreignObject x="30" y="30" width="40" height="40">
              <div
                class="h-full flex items-center justify-center text-brand-600"
                id="icon-p"
              >
                <i class="fas fa-drumstick-bite text-xl"></i>
              </div>
            </foreignObject>
          </svg>
          <div class="text-center mt-2">
            <span id="val-p" class="block text-sm font-bold text-slate-700"
              >--</span
            >
            <span
              id="label-p"
              class="text-[10px] text-slate-400 font-semibold uppercase"
              >Restante</span
            >
          </div>
        </div>

        <!-- CARBOIDRATO -->
        <div
          class="bg-white p-4 rounded-2xl shadow-soft flex flex-col items-center justify-center relative overflow-hidden group"
        >
          <svg
            class="w-16 h-16 transform transition-transform group-hover:scale-105"
            viewBox="0 0 100 100"
          >
            <circle
              class="text-slate-100"
              stroke-width="8"
              stroke="currentColor"
              fill="transparent"
              r="42"
              cx="50"
              cy="50"
            />
            <circle
              id="ring-c"
              class="text-amber-400 progress-ring__circle"
              stroke-width="8"
              stroke-linecap="round"
              stroke="currentColor"
              fill="transparent"
              r="42"
              cx="50"
              cy="50"
              stroke-dasharray="263.8"
              stroke-dashoffset="0"
            />
            <foreignObject x="30" y="30" width="40" height="40">
              <div
                class="h-full flex items-center justify-center text-amber-500"
                id="icon-c"
              >
                <i class="fas fa-bread-slice text-xl"></i>
              </div>
            </foreignObject>
          </svg>
          <div class="text-center mt-2">
            <span id="val-c" class="block text-sm font-bold text-slate-700"
              >--</span
            >
            <span
              id="label-c"
              class="text-[10px] text-slate-400 font-semibold uppercase"
              >Restante</span
            >
          </div>
        </div>

        <!-- GORDURA -->
        <div
          class="bg-white p-4 rounded-2xl shadow-soft flex flex-col items-center justify-center relative overflow-hidden group"
        >
          <svg
            class="w-16 h-16 transform transition-transform group-hover:scale-105"
            viewBox="0 0 100 100"
          >
            <circle
              class="text-slate-100"
              stroke-width="8"
              stroke="currentColor"
              fill="transparent"
              r="42"
              cx="50"
              cy="50"
            />
            <circle
              id="ring-f"
              class="text-blue-400 progress-ring__circle"
              stroke-width="8"
              stroke-linecap="round"
              stroke="currentColor"
              fill="transparent"
              r="42"
              cx="50"
              cy="50"
              stroke-dasharray="263.8"
              stroke-dashoffset="0"
            />
            <foreignObject x="30" y="30" width="40" height="40">
              <div
                class="h-full flex items-center justify-center text-blue-500"
                id="icon-f"
              >
                <i class="fas fa-tint text-xl"></i>
              </div>
            </foreignObject>
          </svg>
          <div class="text-center mt-2">
            <span id="val-f" class="block text-sm font-bold text-slate-700"
              >--</span
            >
            <span
              id="label-f"
              class="text-[10px] text-slate-400 font-semibold uppercase"
              >Restante</span
            >
          </div>
        </div>
      </section>

      <!-- Water Tracker -->
      <section
        class="bg-white rounded-3xl shadow-soft p-1 overflow-hidden relative"
      >
        <div class="relative z-10 p-5">
          <div class="flex justify-between items-end mb-4">
            <div>
              <h2 class="font-display font-bold text-slate-700 text-lg">
                Hidratação
              </h2>
              <p class="text-xs text-slate-400 font-medium mt-1">
                Meta diária: <span id="water-goal-display">4000</span>ml
              </p>
            </div>
            <div class="text-right">
              <span id="water-display" class="text-2xl font-bold text-blue-600"
                >0</span
              >
              <span class="text-sm text-blue-400 font-medium">ml</span>
            </div>
          </div>

          <div
            class="h-6 w-full bg-slate-100 rounded-full overflow-hidden mb-5 relative shadow-inner-light"
          >
            <div
              id="water-bar"
              class="h-full w-0 liquid-bg rounded-full relative"
            >
              <div
                class="absolute top-0 right-0 w-full h-full bg-white opacity-20 animate-pulse"
              ></div>
            </div>
          </div>

          <!-- Alterado de grid-cols-4 para grid-cols-5 para caber o novo botão -->
          <div class="grid grid-cols-5 gap-2">
            <button
              id="btn-water-250"
              class="col-span-1 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold text-sm hover:bg-blue-100 active:scale-95 transition flex flex-col items-center gap-1 opacity-50 cursor-not-allowed"
            >
              <i class="fas fa-glass-water text-xs"></i> 250
            </button>
            <button
              id="btn-water-500"
              class="col-span-1 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold text-sm hover:bg-blue-100 active:scale-95 transition flex flex-col items-center gap-1 opacity-50 cursor-not-allowed"
            >
              <i class="fas fa-bottle-water text-xs"></i> 500
            </button>

            <!-- Novo Botão de 750ml -->
            <button
              id="btn-water-750"
              class="col-span-1 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold text-sm hover:bg-blue-100 active:scale-95 transition flex flex-col items-center gap-1 opacity-50 cursor-not-allowed"
            >
              <i class="fas fa-bottle-water text-xs"></i> 750
            </button>

            <button
              id="btn-water-1000"
              class="col-span-1 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold text-sm hover:bg-blue-100 active:scale-95 transition flex flex-col items-center gap-1 opacity-50 cursor-not-allowed"
            >
              <i class="fas fa-jug-detergent text-xs"></i> 1L
            </button>
            <button
              id="btn-water-reset"
              class="col-span-1 py-3 rounded-xl bg-slate-50 text-slate-400 hover:text-red-500 hover:bg-red-50 transition active:scale-95 opacity-50 cursor-not-allowed"
            >
              <i class="fas fa-rotate-left"></i>
            </button>
          </div>
        </div>
      </section>

      <!-- Refeições -->
      <section>
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-display font-bold text-slate-800 text-lg">
            Refeições
          </h2>
          <div
            class="text-xs font-semibold px-3 py-1 bg-slate-100 text-slate-500 rounded-full"
          >
            <span id="completed-meals">0</span>/5 Feitas
          </div>
        </div>

        <div id="meals-container" class="space-y-4">
          <!-- Carregando Skeleton -->
          <div
            class="animate-pulse flex space-x-4 p-5 bg-white rounded-2xl shadow-sm"
          >
            <div class="rounded-full bg-slate-200 h-10 w-10"></div>
            <div class="flex-1 space-y-4 py-1">
              <div class="h-4 bg-slate-200 rounded w-3/4"></div>
              <div class="space-y-2">
                <div class="h-4 bg-slate-200 rounded"></div>
                <div class="h-4 bg-slate-200 rounded w-5/6"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Botão para Forçar Importação do Plano Padrão -->
      <div class="pt-8 pb-4 text-center">
        <button
          onclick="importDefaultPlan()"
          class="text-xs text-slate-400 hover:text-brand-600 underline transition-colors"
        >
          <i class="fas fa-database mr-1"></i> Restaurar Plano Original para o
          Firebase
        </button>
      </div>
    </main>

    <!-- FIREBASE MODULE -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithCustomToken,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        getDoc,
        collection,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- DADOS PADRÃO COMPLETO (PERFIL + DIETA) ---
      const DEFAULT_PLAN = {
        profile: {
          weight: "84.7kg",
          height: "1.76m",
          goal: "Recomposição Corporal",
          trainingFreq: "5x/semana",
        },
        macros: { p: 175, c: 215, f: 75 },
        goalWater: 4000,
        meals: [
          {
            id: 1,
            time: "07:30",
            title: "Café da Manhã",
            calories: "Cuscuz + Ovos",
            icon: "fa-mug-hot",
            color: "text-amber-500",
            bg: "bg-amber-50",
            macros: { p: 32, c: 45, f: 22 },
            items: [
              "150g Cuscuz de Milho",
              "4 Ovos Mexidos",
              "Café preto (sem açúcar)",
            ],
          },
          {
            id: 2,
            time: "12:30",
            title: "Almoço",
            calories: "Sólido",
            icon: "fa-bowl-food",
            color: "text-emerald-500",
            bg: "bg-emerald-50",
            macros: { p: 48, c: 60, f: 18 },
            items: [
              "150g Frango/Patinho",
              "150g Arroz",
              "100g Feijão",
              "Salada + Azeite",
            ],
          },
          {
            id: 3,
            time: "16:30",
            title: "Pré-Treino",
            calories: "Energia",
            icon: "fa-bolt",
            color: "text-yellow-500",
            bg: "bg-yellow-50",
            macros: { p: 25, c: 50, f: 15 },
            items: [
              "2 fatias Pão Integral",
              "2 Ovos ou 80g Frango",
              "1 Maçã/Melão",
            ],
          },
          {
            id: 4,
            time: "19:00",
            title: "Pós-Treino",
            calories: "Recuperação",
            icon: "fa-glass-water",
            color: "text-blue-500",
            bg: "bg-blue-50",
            macros: { p: 25, c: 25, f: 1 },
            items: ["30g Whey Protein", "250ml Água Gelada", "1 Banana"],
          },
          {
            id: 5,
            time: "20:30",
            title: "Jantar",
            calories: "Leve",
            icon: "fa-moon",
            color: "text-indigo-500",
            bg: "bg-indigo-50",
            macros: { p: 45, c: 35, f: 19 },
            items: [
              "150g Peixe/Frango",
              "200g Batata/Mandioca",
              "Legumes cozidos",
              "Azeite",
            ],
          },
        ],
      };

      // --- FIREBASE SETUP ---
      const firebaseConfig = {
        apiKey: "AIzaSyAO0_OgxgloGQXN-bdCkiWyxlGvKI3f-fU",
        authDomain: "app-dieta-8cd8d.firebaseapp.com",
        projectId: "app-dieta-8cd8d",
        storageBucket: "app-dieta-8cd8d.firebasestorage.app",
        messagingSenderId: "213080108189",
        appId: "1:213080108189:web:6efbeef452753cf4a53874",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const appId = "app-dieta-8cd8d";

      let currentUser = null;
      let todayKey = "";
      let useLocalStorage = false; // Flag para modo offline

      // Estado Global da Aplicação
      let currentPlan = { ...DEFAULT_PLAN }; // Inicia com o padrão
      let appState = {
        water: 0,
        checkedMeals: [],
        date: "",
      };

      // --- INICIALIZAÇÃO ---
      async function init() {
        renderDate();

        // Autenticação com Fallback
        try {
          // Tenta login anônimo
          await signInAnonymously(auth);
        } catch (error) {
          console.warn("Firebase Auth Error:", error.code);

          // Se o erro for de operação restrita, significa que a Auth Anônima está desativada no console
          if (error.code === "auth/admin-restricted-operation") {
            // Não vamos usar alert() para não bloquear, apenas log e modo offline
            console.log(
              "Modo Offline ativado: Ative 'Anonymous Auth' no console do Firebase para sincronizar."
            );
            updateAuthStatus("offline-config");
          } else {
            updateAuthStatus("offline");
          }

          // Ativa modo offline
          useLocalStorage = true;
          startOfflineMode();
        }

        // Observar estado da auth (só dispara se o login funcionar)
        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log("Conectado ao Firebase:", user.uid);
            currentUser = user;
            useLocalStorage = false;
            updateAuthStatus("connected");
            startFirestoreListeners();
          } else {
            // Se não tiver user e não estivermos já em modo offline forçado
            if (!useLocalStorage) {
              // Pode acontecer no logout ou inicialização
            }
          }
        });

        setupButtons();

        // Expor função globalmente para o HTML acessar
        window.editWeight = editWeight;
        window.importDefaultPlan = importDefaultPlan;
      }

      // --- FUNÇÃO DE IMPORTAÇÃO MANUAL ---
      async function importDefaultPlan() {
        if (useLocalStorage || !currentUser) {
          if (
            confirm(
              "Você está offline. Deseja resetar os dados locais para o padrão?"
            )
          ) {
            localStorage.setItem(
              "diet_plan_config",
              JSON.stringify(DEFAULT_PLAN)
            );
            currentPlan = { ...DEFAULT_PLAN };
            renderProfile();
            renderMeals();
            updateMacrosUI();
            updateWaterUI();
            alert("Dados locais resetados!");
          }
          return;
        }

        if (
          confirm(
            "ATENÇÃO: Isso irá sobrescrever seu plano atual no Firebase com o cardápio padrão original. Suas refeições de hoje serão mantidas, mas as metas e itens do menu serão resetados. Continuar?"
          )
        ) {
          try {
            const docRef = doc(
              db,
              "artifacts",
              appId,
              "users",
              currentUser.uid,
              "config",
              "diet_plan"
            );
            await setDoc(docRef, DEFAULT_PLAN); // Sobrescreve
            alert("Plano padrão importado para o Firebase com sucesso!");
            // O onSnapshot vai atualizar a tela automaticamente
          } catch (e) {
            console.error("Erro ao importar:", e);
            alert("Erro ao importar plano. Verifique o console.");
          }
        }
      }

      function updateAuthStatus(status) {
        const indicator = document.getElementById("auth-status");
        if (status === "connected") {
          indicator.innerHTML = '<i class="fas fa-cloud text-xs"></i>';
          indicator.classList.remove(
            "bg-slate-100",
            "text-slate-400",
            "bg-red-100",
            "text-red-500",
            "bg-yellow-100",
            "text-yellow-600"
          );
          indicator.classList.add("bg-emerald-100", "text-emerald-600");
          indicator.title = "Online: Sincronizado";
        } else if (status === "offline-config") {
          indicator.innerHTML =
            '<i class="fas fa-exclamation-triangle text-xs"></i>';
          indicator.classList.remove(
            "bg-slate-100",
            "text-slate-400",
            "bg-emerald-100",
            "text-emerald-600"
          );
          indicator.classList.add("bg-yellow-100", "text-yellow-600");
          indicator.title = "Offline: Ative Auth Anônima no Firebase";
          // Mostra um aviso amigável na tela (Toast)
          showToast(
            "Modo Offline: Ative 'Anonymous Auth' no Firebase para sincronizar."
          );
        } else {
          indicator.innerHTML = '<i class="fas fa-wifi-slash text-xs"></i>';
          indicator.classList.remove(
            "bg-emerald-100",
            "text-emerald-600",
            "bg-yellow-100",
            "text-yellow-600"
          );
          indicator.classList.add("bg-slate-100", "text-slate-400");
          indicator.title = "Offline";
        }
      }

      function showToast(message) {
        const toast = document.createElement("div");
        toast.className =
          "fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-semibold shadow-lg z-50 animate-bounce";
        toast.innerText = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
      }

      // --- LÓGICA DE ATUALIZAÇÃO DE PESO E MACROS ---
      async function editWeight() {
        // Pega o peso atual (remove 'kg' se tiver)
        const currentWeightStr = currentPlan.profile.weight.replace(
          /[^0-9.]/g,
          ""
        );
        const newWeightInput = prompt(
          "Digite seu novo peso (kg):",
          currentWeightStr
        );

        if (newWeightInput) {
          // Converte vírgula para ponto e analisa
          const newWeight = parseFloat(newWeightInput.replace(",", "."));

          if (!isNaN(newWeight) && newWeight > 30 && newWeight < 300) {
            await updateProfileAndMacros(newWeight);
            showToast(`Metas recalculadas para ${newWeight}kg!`);
          } else {
            alert("Peso inválido. Digite um número ex: 85.5");
          }
        }
      }

      async function updateProfileAndMacros(weight) {
        // 1. Atualiza Perfil
        currentPlan.profile.weight = `${weight}kg`;

        // 2. Recalcula Macros (Baseado em Recomposição: P=2.1, C=2.5, F=0.9)
        currentPlan.macros = {
          p: Math.round(weight * 2.1),
          c: Math.round(weight * 2.5),
          f: Math.round(weight * 0.9),
        };

        // 3. Recalcula Água (Aprox 47ml/kg para atletas/ativos)
        const newWaterGoal = Math.round(weight * 47);
        // Arredonda para o 100 mais próximo para ficar bonito (ex: 3980 -> 4000)
        currentPlan.goalWater = Math.ceil(newWaterGoal / 100) * 100;

        // 4. Salva (Online ou Offline)
        if (useLocalStorage || !currentUser) {
          localStorage.setItem("diet_plan_config", JSON.stringify(currentPlan));
          // Atualiza UI manualmente
          renderProfile();
          updateMacrosUI();
          updateWaterUI();
        } else {
          try {
            const docRef = doc(
              db,
              "artifacts",
              appId,
              "users",
              currentUser.uid,
              "config",
              "diet_plan"
            );
            await setDoc(docRef, currentPlan, { merge: true });
            // O onSnapshot cuidará da atualização da UI
          } catch (e) {
            console.error("Erro ao salvar perfil:", e);
            // Fallback
            localStorage.setItem(
              "diet_plan_config",
              JSON.stringify(currentPlan)
            );
            renderProfile();
            updateMacrosUI();
            updateWaterUI();
          }
        }
      }

      // --- MODO OFFLINE (LOCAL STORAGE) ---
      function startOfflineMode() {
        enableControls();

        // 1. Carregar Plano
        const savedPlan = localStorage.getItem("diet_plan_config");
        if (savedPlan) {
          currentPlan = JSON.parse(savedPlan);
        } else {
          currentPlan = { ...DEFAULT_PLAN };
          localStorage.setItem("diet_plan_config", JSON.stringify(currentPlan));
        }

        // 2. Carregar Stats Diários
        const savedStats = localStorage.getItem(`daily_stats_${todayKey}`);
        if (savedStats) {
          appState = JSON.parse(savedStats);
        } else {
          appState = { water: 0, checkedMeals: [], date: todayKey };
        }

        // Renderizar
        renderMeals();
        updateMacrosUI();
        updateWaterUI();
        renderProfile(); // Renderiza perfil
      }

      // --- MODO ONLINE (FIRESTORE) ---
      function startFirestoreListeners() {
        subscribeToPlan();
        subscribeToDailyStats();
      }

      // --- DATA LAYER 1: CONFIGURAÇÃO DO PLANO ---
      function subscribeToPlan() {
        if (!currentUser) return;
        const docRef = doc(
          db,
          "artifacts",
          appId,
          "users",
          currentUser.uid,
          "config",
          "diet_plan"
        );

        onSnapshot(
          docRef,
          async (docSnap) => {
            if (docSnap.exists()) {
              currentPlan = docSnap.data();

              // Visual feedback: Flash green on update
              const profileEl = document.getElementById("profile-text");
              if (profileEl) {
                profileEl.classList.add("text-emerald-500", "font-bold");
                setTimeout(
                  () =>
                    profileEl.classList.remove("text-emerald-500", "font-bold"),
                  800
                );
              }
            } else {
              await setDoc(docRef, DEFAULT_PLAN, { merge: true });
              currentPlan = { ...DEFAULT_PLAN };
            }

            renderMeals();
            updateMacrosUI();
            updateWaterUI();
            renderProfile(); // Renderiza perfil vindo do DB
          },
          (error) => {
            console.error("Erro plano:", error);
          }
        );
      }

      // --- DATA LAYER 2: ESTADO DIÁRIO ---
      function subscribeToDailyStats() {
        if (!currentUser) return;
        const docRef = doc(
          db,
          "artifacts",
          appId,
          "users",
          currentUser.uid,
          "daily_stats",
          todayKey
        );

        onSnapshot(
          docRef,
          (docSnap) => {
            enableControls();

            if (docSnap.exists()) {
              appState = docSnap.data();
            } else {
              appState = {
                water: 0,
                checkedMeals: [],
                date: todayKey,
              };
              saveDailyData();
            }

            updateWaterUI();
            renderMeals();
            updateMacrosUI();
          },
          (error) => {
            console.error("Erro dados diários:", error);
          }
        );
      }

      // --- FUNÇÃO DE SALVAR UNIFICADA (ONLINE/OFFLINE) ---
      async function saveDailyData() {
        if (useLocalStorage || !currentUser) {
          // Salvar no LocalStorage
          localStorage.setItem(
            `daily_stats_${todayKey}`,
            JSON.stringify(appState)
          );
          return;
        }

        // Salvar no Firestore
        try {
          const docRef = doc(
            db,
            "artifacts",
            appId,
            "users",
            currentUser.uid,
            "daily_stats",
            todayKey
          );
          await setDoc(docRef, appState, { merge: true });
        } catch (e) {
          console.error("Erro ao salvar:", e);
          // Fallback silencioso se perder conexão momentaneamente
          localStorage.setItem(
            `daily_stats_${todayKey}`,
            JSON.stringify(appState)
          );
        }
      }

      // --- LÓGICA DE UI ---
      function renderDate() {
        const dateObj = new Date();

        // --- 1. DATA COMPLETA (Subtítulo) ---
        const optionsDate = { day: "numeric", month: "long", year: "numeric" };
        let dateStr = dateObj.toLocaleDateString("pt-BR", optionsDate);

        // Ajuste visual: Transforma " de janeiro" em " de Janeiro"
        dateStr = dateStr.replace(
          / de ([a-z])/g,
          (match, letter) => ` de ${letter.toUpperCase()}`
        );
        document.getElementById(
          "current-date"
        ).innerText = `Brasília, ${dateStr}`;

        // --- 2. DIA DA SEMANA (Título Principal) ---
        const optionsWeekday = { weekday: "long" };
        let weekdayStr = dateObj.toLocaleDateString("pt-BR", optionsWeekday);

        // Capitalizar a primeira letra
        weekdayStr = weekdayStr.charAt(0).toUpperCase() + weekdayStr.slice(1);

        const weekdayEl = document.getElementById("current-weekday");
        if (weekdayEl) weekdayEl.innerText = weekdayStr;

        // --- Lógica de Virada de Dia (Meia-noite) ---
        const newKey = dateObj.toDateString();

        if (todayKey && todayKey !== newKey) {
          window.location.reload();
        } else {
          todayKey = newKey;
        }
      }

      function renderProfile() {
        const elText = document.getElementById("profile-text");
        const elContainer = document.getElementById("profile-summary");

        if (currentPlan && currentPlan.profile && elText) {
          elText.innerHTML = `${currentPlan.profile.weight} &bull; ${currentPlan.profile.goal}`;
          elContainer.classList.remove("opacity-0");
        }
      }

      function enableControls() {
        const buttons = document.querySelectorAll("button");
        buttons.forEach((btn) => {
          btn.classList.remove("opacity-50", "cursor-not-allowed");
          btn.disabled = false;
        });
      }

      // --- ACTIONS (ÁGUA) ---
      window.handleWater = (amount) => {
        if (amount === 0) {
          if (confirm("Zerar contador de água?")) {
            appState.water = 0;
            saveDailyData();
            updateWaterUI(); // Force update para modo offline
          }
        } else {
          const maxWater = currentPlan.goalWater + 1000;
          appState.water += amount;
          if (appState.water > maxWater) appState.water = maxWater;

          if (
            appState.water >= currentPlan.goalWater &&
            appState.water - amount < currentPlan.goalWater
          ) {
            triggerConfetti();
          }
          saveDailyData();
          updateWaterUI(); // Force update para modo offline
        }
      };

      function updateWaterUI() {
        const display = document.getElementById("water-display");
        const goalDisplay = document.getElementById("water-goal-display");
        const bar = document.getElementById("water-bar");
        const goal = currentPlan.goalWater || 4000; // Fallback

        // Atualiza display da meta
        if (goalDisplay) goalDisplay.innerText = goal;

        display.innerText = appState.water;

        const percentage = Math.min((appState.water / goal) * 100, 100);
        bar.style.height = "100%";
        bar.style.width = `${percentage}%`;

        if (appState.water >= goal) {
          bar.classList.remove("liquid-bg");
          bar.classList.add("bg-emerald-500");
        } else {
          bar.classList.add("liquid-bg");
          bar.classList.remove("bg-emerald-500");
        }
      }

      // --- ACTIONS (REFEIÇÕES) ---
      window.toggleMeal = (id) => {
        if (appState.checkedMeals.includes(id)) {
          appState.checkedMeals = appState.checkedMeals.filter(
            (mid) => mid !== id
          );
        } else {
          appState.checkedMeals.push(id);
          if (navigator.vibrate) navigator.vibrate(50);

          if (appState.checkedMeals.length === currentPlan.meals.length) {
            triggerConfetti();
          }
        }
        saveDailyData();
        // Force updates para modo offline
        renderMeals();
        updateMacrosUI();
      };

      function renderMeals() {
        const container = document.getElementById("meals-container");
        container.innerHTML = "";
        let completedCount = 0;

        currentPlan.meals.forEach((meal) => {
          const isChecked = appState.checkedMeals.includes(meal.id);
          if (isChecked) completedCount++;

          const opacityClass = isChecked
            ? "opacity-60 grayscale"
            : "opacity-100";
          const bgClass = isChecked ? "bg-slate-50" : "bg-white";

          const html = `
                    <div class="relative overflow-hidden rounded-2xl border border-slate-100 shadow-soft transition-all duration-300 ${opacityClass} ${bgClass}">
                        <label class="block p-5 cursor-pointer relative z-10">
                            <div class="flex items-start gap-4">
                                <div class="relative pt-1">
                                    <input type="checkbox" class="peer sr-only" 
                                        onchange="toggleMeal(${meal.id})" 
                                        ${isChecked ? "checked" : ""}>
                                    <div class="w-6 h-6 rounded-full border-2 border-slate-300 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 transition-colors flex items-center justify-center checkbox-bounce">
                                        <i class="fas fa-check text-white text-xs ${
                                          isChecked ? "block" : "hidden"
                                        }"></i>
                                    </div>
                                </div>

                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <span class="text-xs font-bold text-slate-400 tracking-wider">${
                                              meal.time
                                            }</span>
                                            <h3 class="font-display font-bold text-slate-800 text-lg ${
                                              isChecked
                                                ? "line-through text-slate-400"
                                                : ""
                                            }">${meal.title}</h3>
                                        </div>
                                        <div class="w-8 h-8 rounded-full ${
                                          meal.bg
                                        } flex items-center justify-center ${
            meal.color
          }">
                                            <i class="fas ${meal.icon}"></i>
                                        </div>
                                    </div>

                                    <div class="mt-3 space-y-1">
                                        ${meal.items
                                          .map(
                                            (item) => `
                                            <div class="flex items-center gap-2 text-sm text-slate-600">
                                                <div class="w-1 h-1 rounded-full bg-slate-300"></div>
                                                ${item}
                                            </div>
                                        `
                                          )
                                          .join("")}
                                    </div>
                                    
                                    <div class="mt-3 pt-3 border-t border-slate-100 flex gap-3 text-[10px] text-slate-400 uppercase font-bold">
                                        <span>P: ${meal.macros.p}g</span>
                                        <span>C: ${meal.macros.c}g</span>
                                        <span>G: ${meal.macros.f}g</span>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
          container.innerHTML += html;
        });

        document.getElementById("completed-meals").innerText = completedCount;
      }

      // --- MACROS ---
      function updateMacrosUI() {
        let consumed = { p: 0, c: 0, f: 0 };

        appState.checkedMeals.forEach((mealId) => {
          const meal = currentPlan.meals.find((m) => m.id === mealId);
          if (meal) {
            consumed.p += meal.macros.p;
            consumed.c += meal.macros.c;
            consumed.f += meal.macros.f;
          }
        });

        const total = currentPlan.macros;
        const remaining = {
          p: total.p - consumed.p,
          c: total.c - consumed.c,
          f: total.f - consumed.f,
        };

        updateSingleMacro("p", remaining.p, total.p);
        updateSingleMacro("c", remaining.c, total.c);
        updateSingleMacro("f", remaining.f, total.f);
      }

      function updateSingleMacro(type, remainingVal, totalVal) {
        const elVal = document.getElementById(`val-${type}`);
        const elLabel = document.getElementById(`label-${type}`);
        const elRing = document.getElementById(`ring-${type}`);
        const elIcon = document.getElementById(`icon-${type}`);

        // Safety check
        if (!elVal || !elLabel || !elRing || !elIcon) return;

        const displayVal = remainingVal <= 0 ? 0 : remainingVal;
        elVal.innerText = `${displayVal}g`;

        if (remainingVal <= 0) {
          elLabel.innerText = "CONCLUÍDO!";
          elLabel.className =
            "text-[10px] font-bold text-emerald-600 uppercase";
          elVal.className = "block text-sm font-bold text-emerald-600";

          elRing.style.strokeDashoffset = "0";
          elRing.classList.remove(
            "text-brand-500",
            "text-amber-400",
            "text-blue-400"
          );
          elRing.classList.add("text-emerald-500");

          elIcon.classList.remove(
            "text-brand-600",
            "text-amber-500",
            "text-blue-500"
          );
          elIcon.classList.add("text-emerald-600");
        } else {
          elLabel.innerText = "RESTANTE";
          elLabel.className =
            "text-[10px] text-slate-400 font-semibold uppercase";
          elVal.className = "block text-sm font-bold text-slate-700";

          const circumference = 263.8;
          const percentRemaining = remainingVal / totalVal;
          const percentConsumed = 1 - Math.max(0, percentRemaining);
          const offset = circumference - percentConsumed * circumference;

          elRing.style.strokeDashoffset = offset;

          if (type === "p") {
            elRing.classList.remove("text-emerald-500");
            elRing.classList.add("text-brand-500");
            elIcon.classList.remove("text-emerald-600");
            elIcon.classList.add("text-brand-600");
          } else if (type === "c") {
            elRing.classList.remove("text-emerald-500");
            elRing.classList.add("text-amber-400");
            elIcon.classList.remove("text-emerald-600");
            elIcon.classList.add("text-amber-500");
          } else if (type === "f") {
            elRing.classList.remove("text-emerald-500");
            elRing.classList.add("text-blue-400");
            elIcon.classList.remove("text-emerald-600");
            elIcon.classList.add("text-blue-500");
          }
        }
      }

      function triggerConfetti() {
        var count = 200;
        var defaults = { origin: { y: 0.7 } };
        function fire(particleRatio, opts) {
          confetti(
            Object.assign({}, defaults, opts, {
              particleCount: Math.floor(count * particleRatio),
            })
          );
        }
        fire(0.25, { spread: 26, startVelocity: 55 });
        fire(0.2, { spread: 60 });
        fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
      }

      function setupButtons() {
        document.getElementById("btn-water-250").onclick = () =>
          window.handleWater(250);
        document.getElementById("btn-water-500").onclick = () =>
          window.handleWater(500);
        document.getElementById("btn-water-750").onclick = () =>
          window.handleWater(750); // Novo Handler
        document.getElementById("btn-water-1000").onclick = () =>
          window.handleWater(1000);
        document.getElementById("btn-water-reset").onclick = () =>
          window.handleWater(0);
      }

      // START
      init();

      // Verifica a data a cada minuto para atualizar automaticamente na virada do dia
      setInterval(renderDate, 60000);
    </script>
  </body>
</html>
